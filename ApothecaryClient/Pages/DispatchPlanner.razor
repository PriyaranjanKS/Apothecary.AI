@page "/dispatch-planner"
@using System.Reflection.Metadata
@inject HttpClient Http
<ReadinessCheckModal @ref="readinessCheckModal" OnStateChanged="() => RefreshParentComponent()" />
<SchedulePopup @ref="schedulePopup" />

@if (orders == null)
{
    <div class="dispatch-loading-overlay">
        <div class="dispatch-loading-spinner"></div>
        <p class="dispatch-loading-text">Fetching the medicine orders...</p>
    </div>
}

<div class="dispatch-container">
    <div class="dispatch-header">
        <div class="header-left">
            <button class="dispatch-demand-forecast neumorphic" @onclick="ShowDemandForecastPopup">Demand Forecast</button>
        </div>
        <div class="header-center">
            <h2>Total number of Open Orders: @orders?.Count</h2>
        </div>
    </div>
    <div class="dispatch-orders-grid">
        @if (orders != null)
        {
            @foreach (var order in orders)
            {
                <div class="dispatch-order-card neumorphic">
                    <div class="dispatch-order-row">
                        <div class="dispatch-order-column">Order #: @order.OrderNumber</div>
                        <div class="dispatch-order-column">Order Date: @FormatOrderDate(order.OrderDate)</div>
                    </div>
                    <div class="dispatch-order-row">
                        <div class="dispatch-order-column">Customer Name: @order.CustomerName</div>
                        <div class="dispatch-order-column">Total Items: @order.TotalItems</div>
                    </div>
                    <div class="dispatch-order-row">
                        <div class="dispatch-order-column @GetDispatchStatusClass(order.DispatchStatus)">
                            Dispatch Status: @GetDispatchStatusText(order.DispatchStatus)
                        </div>
                        <div class="dispatch-order-column">Readiness Check: @order.Readiness</div>
                    </div>
                    <div class="dispatch-order-row">
                        <div class="dispatch-order-actions">
                            <button class="dispatch-readiness-check" @onclick="() => CheckReadiness(order.OrderNumber)">Readiness Check</button>
                            <button class="dispatch-schedule" @onclick="() => OnScheduleClick(order)">Schedule</button>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>
@if (showDemandForecastPopup)
{
     <div class="demand-forecast-overlay">
    <div class="demand-forecast-popup" >
        <div class="demand-forecast-left neumorphic">
            <h3 class="demand-forecast-heading">Demand Forecast</h3>
            <div class="demand-forecast-controls">
                <label>Medicine Name:</label>
                <select class="medicine-dropdown neumorphic">
                    <option value="FocusFusion">FocusFusion</option>
                    <option value="DiabeControl">DiabeControl</option>
                    <option value="MorphEase">MorphEase</option>
                    <option value="MorphineInject">MorphineInject</option>
                </select>
                <label>Manufacturer:</label>
                <select class="manufacturer-dropdown neumorphic">
                    <option value="ClarityWaves">ClarityWaves</option>
                    <option value="InsuLife">InsuLife</option>
                    <option value="EasePharma">EasePharma</option>
                    <option value="InjectCare">InjectCare</option>
                </select>
                <label>Forecast Date:</label>
                <input type="date" class="forecast-date neumorphic">
                <label>Unit Price:</label>
                <input type="text" class="unit-price neumorphic">
                <label>Discount:</label>
                <input type="text" class="discount neumorphic">
                <button class="forecast-button neumorphic">Forecast</button>
            </div>
        </div>
        <div class="demand-forecast-right neumorphic">
            <div class="demand-forecast-container">
                <h4 class="forecast-container-heading">Azure ML Demand Forecast</h4>
                <p class="forecast-container-text">This is the Azure ML demand forecast text.</p>
            </div>
            <div class="demand-forecast-container">
                <h4 class="forecast-container-heading">Azure Open AI Suggestions</h4>
                <p class="forecast-container-text">These are the Azure Open AI suggestions text.</p>
            </div>
        </div>
    </div>
</div>
}
@code {
    private List<Order> orders;
    private ReadinessCheckModal readinessCheckModal;
    private SchedulePopup schedulePopup;
    private bool showDemandForecastPopup = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            orders = await Http.GetFromJsonAsync<List<Order>>("api/DispatchOrders");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private async Task OnScheduleClick(Order order)
    {
        if (schedulePopup != null)
        {
            await schedulePopup.ShowPopup(order.OrderNumber, order.CustomerName);
        }
    }

    private async Task CheckReadiness(string orderNumber)
    {
        await readinessCheckModal.ShowModal(orderNumber);
    }

    private string FormatOrderDate(DateTime orderDate)
    {
        return orderDate.ToString("dd/MM/yyyy");
    }

    private string GetDispatchStatusClass(string dispatchStatus)
    {
        return dispatchStatus switch
        {
            "Packaging Completed" => "dispatch-status-packaging-completed",
            "Order Accepted" => "dispatch-status-order-accepted",
            "Packaging In Progress" => "dispatch-status-packaging-in-progress",
            _ => string.Empty
        };
    }

    private string GetDispatchStatusText(string dispatchStatus)
    {
        return dispatchStatus ?? "Unknown";
    }

    private class Order
    {
        public string OrderNumber { get; set; }
        public DateTime OrderDate { get; set; }
        public string CustomerName { get; set; }
        public int TotalItems { get; set; }
        public string DispatchStatus { get; set; }
        public string Readiness { get; set; }
    }
    private void RefreshParentComponent()
    {
        StateHasChanged();
    }
    private void ShowDemandForecastPopup()
    {
        showDemandForecastPopup = true;
    }

    private void CloseDemandForecastPopup()
    {
        showDemandForecastPopup = false;
    }
}
