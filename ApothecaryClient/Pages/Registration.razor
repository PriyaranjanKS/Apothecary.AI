@page "/registration"
@inject TranslationService TranslationService
@using System.ComponentModel.DataAnnotations
@using System.Text;
@using ApothecaryShared
@using Newtonsoft.Json
@inject HttpClient HttpClient

@if (isProcessing)
{
    <div class="overlay">
        <div class="overlay-content">
            <!-- This now uses the same class as translation -->
            <div class="spinner"></div> <!-- If you have a spinner for the processing state -->
            <p>Extracting the ID Card Content, Please wait...</p>
        </div>
    </div>
}

@if (isTranslating)
{
    <div class="overlay">
        <div class="overlay-content">
            <!-- Updated class name for consistency -->
            <div class="spinner"></div> <!-- Spinner is already centrally aligned with updated CSS -->
            <p>Processing language translation, Please wait...</p>
        </div>
    </div>
}
<div class="registration-page">
    <div class="image-upload-container">
        <label for="fileUpload">@translations["UploadID"]</label>
        <InputFile id="fileUpload" OnChange="HandleFileUpload" class="form-control-file" />
        @if (!string.IsNullOrEmpty(imageUrl))
        {
            <img src="@imageUrl" alt="File Upload Image" class="uploaded-image" />
        }
    </div>

    <div class="registration-container">
        <div class="header">
            <h2 class="registration-title">@translations["UserRegistrationTitle"]</h2>
            <div class="locale-container">
                <span class="locale-subtitle">@translations["LocaleSelector"]</span>
                <select id="localeSelector" @onchange="OnLocaleChange" class="locale-selector">
                    <option value="English">English</option>
                    <option value="French">French</option>
                    <option value="Japanese">Japanese</option>
                    <option value="Chinese">Chinese</option>
                    <option value="German">German</option>
                    <option value="Portuguese">Portuguese</option>
                    <!-- ... other locales ... -->
                </select>
            </div>
        </div>

        <EditForm Model="@registrationModel" OnValidSubmit="HandleValidSubmit">
            <div class="form-row">
                <div class="form-column customer-details-container">
                    <h3 class="sub-heading">@translations["CustomerDetailsHeading"]</h3>
                    <div class="form-group">
                        <label for="name">@translations["NameLabel"]</label>
                        <InputText id="name" @bind-Value="registrationModel.Name" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="dob">@translations["DateOfBirthLabel"]</label>
                        <InputDate id="dob" @bind-Value="registrationModel.DateOfBirth" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="gender">@translations["GenderLabel"]</label>
                        <InputSelect id="gender" @bind-Value="registrationModel.Gender" class="form-control">
                            <option value="">Select...</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="O">Other</option>
                        </InputSelect>
                    </div>
                    <div class="form-group">
                        <label for="address">@translations["AddressLabel"]</label>
                        <InputText id="address" @bind-Value="registrationModel.Address" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="state">@translations["StateLabel"]</label>
                        <InputText id="state" @bind-Value="registrationModel.State" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="country">@translations["CountryLabel"]</label>
                        <InputText id="country" @bind-Value="registrationModel.Country" class="form-control" />
                    </div>
                </div>

                <div class="form-column">
                    <div class="contact-details-container">
                        <h3 class="sub-heading">@translations["ContactDetailsHeading"]</h3>
                        <div class="form-group">
                            <label for="email">@translations["EmailLabel"]</label>
                            <InputText id="email" @bind-Value="registrationModel.Email" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="phone">@translations["PhoneLabel"]</label>
                            <InputText id="phone" @bind-Value="registrationModel.Phone" class="form-control" />
                        </div>
                    </div>

                    <div class="additional-details-container">
                        <h3 class="sub-heading">@translations["OtherDetailsHeading"]</h3>
                        <div class="form-group">
                            <label for="additionalInfo">@translations["AdditionalDetailsLabel"]</label>
                            <InputTextArea id="additionalInfo" @bind-Value="registrationModel.AdditionalDetails" class="form-control" rows="4" />
                        </div>
                        <div class="form-group">
                            <label for="conditions">@translations["PreExistingConditionsLabel"]</label>
                            <InputTextArea id="conditions" @bind-Value="registrationModel.PreExistingConditions" class="form-control" rows="4" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group submit-group">
                <button type="submit" class="submit-button">@translations["SubmitButton"]</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private bool isProcessing = false; // Flag to control the overlay visibility
    private bool isTranslating = false;

    private string locale = "English"; // Default locale
    private RegistrationModel registrationModel = new RegistrationModel();
    private string imageUrl;
    private string message = "";

    private Dictionary<string, string> translations = new Dictionary<string, string>();
    private Dictionary<string, string> keysToTranslate = new Dictionary<string, string>
{
    { "UploadID", "Upload ID:" },
    { "NameLabel", "Name:" },
    { "DateOfBirthLabel", "Date Of Birth:" },
    { "GenderLabel", "Gender:" },
    { "AddressLabel", "Address:" },
    { "StateLabel", "State:" },
    { "CountryLabel", "Country:" },
    { "EmailLabel", "Email:" },
    { "PhoneLabel", "Phone:" },
    { "AdditionalDetailsLabel", "Additional Details:" },
    { "PreExistingConditionsLabel", "Pre-Existing Conditions:" },
    { "SubmitButton", "Submit" },
    { "LocaleSelector", "Locale:" },
    { "CustomerDetailsHeading", "Customer Details" },
    { "ContactDetailsHeading", "Contact Details" },
    { "OtherDetailsHeading", "Other Details" },
    { "UserRegistrationTitle", "User Registration" },
    // ... any other keys and default texts you need to translate
};

    private async Task OnLocaleChange(ChangeEventArgs e)
    {
        isTranslating = true; // Start showing the translation waiting overlay
        locale = e.Value.ToString();
        translations = await TranslationService.GetTranslationsAsync(locale, keysToTranslate);
        isTranslating = false; // Translation finished, hide the waiting overlay
        StateHasChanged(); // Notify Blazor to re-render the page
    }

    protected override async Task OnInitializedAsync()
    {
        translations = await TranslationService.GetTranslationsAsync(locale, keysToTranslate);
    }
    private async Task HandleValidSubmit()
    {
        try
        {
            Console.WriteLine($"Making request to: {HttpClient.BaseAddress}api/registration");
            var response = await HttpClient.PostAsJsonAsync("api/registration", registrationModel);

            if (response.IsSuccessStatusCode)
            {
                message = "Registration successful";
            }
            else
            {
                // Optionally, read the response content for more details
                var responseContent = await response.Content.ReadAsStringAsync();
                message = $"Registration failed: {responseContent}";
            }
        }
        catch (Exception ex)
        {
            // Log the exception details if needed
            message = $"Error occurred: {ex.Message}";
        }
    }
    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        isProcessing = true; // Show the overlay
        var imageFile = e.File;
        if (imageFile != null)
        {
            try
            {
                // Read the file into a buffer
                var buffer = new byte[imageFile.Size];
                await imageFile.OpenReadStream().ReadAsync(buffer);

                // Convert the buffer to a base64 string and assign it to imageUrl
                // for displaying the image on the page
                imageUrl = $"data:{imageFile.ContentType};base64,{Convert.ToBase64String(buffer)}";

                // Prepare the file data for sending to the server
                var fileData = new
                {
                    FileName = imageFile.Name,
                    ContentType = imageFile.ContentType,
                    Content = Convert.ToBase64String(buffer)
                };

                // Serialize the file data to JSON
                var jsonContent = JsonConvert.SerializeObject(fileData);

                // Send the JSON content to the API
                var response = await HttpClient.PostAsync(
                    "api/registration/uploadImage",
                    new StringContent(jsonContent, Encoding.UTF8, "application/json"));

                // Handle the response
                if (response.IsSuccessStatusCode)
                {
                    var responseContent = await response.Content.ReadAsStringAsync();
                    var extractedData = JsonConvert.DeserializeObject<RegistrationModel>(responseContent);

                    // Update registrationModel with the extracted data
                    registrationModel.Name = extractedData.Name;
                    try
                    {
                        // Directly converting string to DateTime
                        registrationModel.DateOfBirth = Convert.ToDateTime(extractedData.DateOfBirth);
                    }
                    catch
                    {
                        // If conversion fails, set DateOfBirth to null
                        registrationModel.DateOfBirth = null;
                    }
                    registrationModel.Gender = extractedData.Gender;
                    registrationModel.Address = extractedData.Address;
                    registrationModel.State = extractedData.State;
                    registrationModel.Country = extractedData.Country;

                    message = "ID Card Image uploaded and content extracted";
                }
                else
                {
                    message = "ID Card Image upload and content extraction failed";
                }
            }
            catch (Exception ex)
            {
                message = $"Error during file upload: {ex.Message}";
            }
            finally
            {
                isProcessing = false; // Ensure this is called even if an error occurs
                StateHasChanged(); // Re-render the component to hide the overlay
            }
        }
    }

 
        /*
     private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
    isProcessing = true; // Show the overlay
    var imageFile = e.File;
    if (imageFile != null)
        {
        // Read the file into a buffer
        var buffer = new byte[imageFile.Size];
        await imageFile.OpenReadStream().ReadAsync(buffer);

        // Convert the buffer to a base64 string and assign it to imageUrl
        // for displaying the image on the page
        imageUrl = $"data:{imageFile.ContentType};base64,{Convert.ToBase64String(buffer)}";

        // Prepare the file data for sending to the server
        var fileData = new
            {
            FileName = imageFile.Name,
            ContentType = imageFile.ContentType,
            Content = Convert.ToBase64String(buffer)
        };

        // Serialize the file data to JSON
        var jsonContent = JsonConvert.SerializeObject(fileData);

        // Send the JSON content to the API
        var response = await HttpClient.PostAsync(
            "api/registration/uploadImage",
            new StringContent(jsonContent, Encoding.UTF8, "application/json"));

        // Handle the response
        if (response.IsSuccessStatusCode)
            {
            var responseContent = await response.Content.ReadAsStringAsync();
            var extractedData = JsonConvert.DeserializeObject<RegistrationModel>(responseContent);

            // Update registrationModel with the extracted data
            registrationModel.Name = extractedData.Name;
            try
                {
                // Directly converting string to DateTime
                registrationModel.DateOfBirth = Convert.ToDateTime(extractedData.DateOfBirth);
            }
            catch
                {
                // If conversion fails, set DateOfBirth to null
                registrationModel.DateOfBirth = null;
            }
            registrationModel.Gender = extractedData.Gender;
            registrationModel.Address = extractedData.Address;
            registrationModel.State = extractedData.State;
            registrationModel.Country = extractedData.Country;
            isProcessing = false; // Hide the overlay
            message = "ID Card Image uploaded and content extracted";
        }
        else
            {
            message = "ID Card Image upload and content extraction failed";
            }
        }
    }

    */

}
